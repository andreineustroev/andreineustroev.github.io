---
layout: post
title:  "Нежелательные вложенные LVM"
date:   2019-10-09 23:29:20 +0500
categories: proxmox, kvm, lvm
---

При использовании виртуализации, в моём случае proxmox, можно отдавать виртуальные диски как raw lvm разделы, но если мы уже внутри виртуалки будем создавать чистый PV LVM, то хост тоже может увидеть эти разделы и VG в которые эти разделы включены, а это не хорошо)) Все операции по управлению lvm становятся задумчивыми, а если таким образом получатся несколько одинаковых VG, то в гугле можно найти очень печальные последствия.

## Решение

Как всегда простое, LVM имеет встроенные средства для решения этой проблемы, это фильтры, причём они уже преднастроены для решения подобного рода проблем (в debian strech). Особенно забавно выглядит правило для pve, видимо в младших версиях proxmox оно помогало, либо в стандартной установке. У меня же кастомная инсталяция, поэтому и правила нужны другие
{% highlight bash %}
global_filter = [ \"r|/dev/zd.*|\", \"r|/dev/mapper/pve-.*|\", \"r|/dev/vg_sas/*|\"  ]
{% endhighlight %}
где vg_sas наша vg в которой мы создаем lv только для виртуалок.
Интересно, что такие вложения сервера замечают только при перезагрузке, потому что именно тогда полностью пересканируются все устройства. Поэтому после записи фильтра нужно запустить pvscan, но не просто так.
{% highlight bash %}
pvscan -d -v --cache --activate a
{% endhighlight %}
а вот так) `-d -v` покажут подробный вывод, а `--cache --activate a` перезапишет кэш и активирует всё что найдёт.