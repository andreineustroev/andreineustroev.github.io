---
layout: post
title:  "HA prometheus"
date:   2020-22-02 23:29:20 +0500
categories: monitoring, prometheus, ha
---

Возникла необходимость сделать отказоустойчивый prometheus, благо что он такое умеет, хоть и немного странно. Но нагуглить какой-то гайд мне сходу не удалось, поэтому пишу свой.

# Вводные
Используем 2 сервера, на каждом только docker + docker-compose без swarm. Большинство гайдов как раз про оркестрацию, мол запускаем несколько prometheus и alertmanager в service-mesh в единственном экземпляре и оно работает, alertmanager же stateless.

Но меня такое не устроило, поэтому приступим.

# Настройка alertmanager

Чтобы переключить alertmanager в кластерный режим нужно указать параметр запуска `--cluster.listen-address=` с любым адресом и портом, например `0.0.0.0:9094`. Параметр `--cluster.advertise-address` так и не понял на что влияет, без него само находится. Так же важно перечислить всех пиров в параметре `--cluster.peer` по параметру на пира.

Естественно 9094 порт нужно открыть, пишут что там tcp и udp но я увидел только tcp.

# Настройка promtheus

Чтобы добавить таких alertmanager ов, нужно в конфиге прометея указать их всех. Они сами между собой договорятся, кто посылает алерты.

`
alerting:
  alertmanagers:
  - static_configs:
    - targets:
      - alertmanager1:9093
      - alertmanager2:9093
      - alertmanager3:9093
`